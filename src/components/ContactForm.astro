---
import { site } from "../data/site";

const formspreeId = import.meta.env.PUBLIC_FORMSPREE_FORM_ID;
const formspreeAction = formspreeId
    ? `https://formspree.io/f/${formspreeId}`
    : undefined;
---

<div class="max-w-2xl mx-auto">
    <!-- Formulario de contacto -->
    <form
        id="contact-form"
        action={formspreeAction}
        method="POST"
        data-email={site.contactEmail}
        class="border-2 border-black bg-white shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] p-8"
    >
        <!-- Nombre -->
        <div class="mb-6">
            <label
                for="name"
                class="block font-mono text-xs uppercase tracking-widest text-gray-500 mb-2"
            >
                Nombre *
            </label>
            <input
                type="text"
                id="name"
                name="name"
                required
                class="w-full px-4 py-3 border-2 border-black focus:outline-none focus:ring-2 focus:ring-black font-mono text-sm"
                placeholder="Tu nombre completo"
            />
        </div>

        <!-- Email -->
        <div class="mb-6">
            <label
                for="email"
                class="block font-mono text-xs uppercase tracking-widest text-gray-500 mb-2"
            >
                Email *
            </label>
            <input
                type="email"
                id="email"
                name="email"
                required
                class="w-full px-4 py-3 border-2 border-black focus:outline-none focus:ring-2 focus:ring-black font-mono text-sm"
                placeholder="tu@email.com"
            />
        </div>

        <!-- Tipo de proyecto (opcional) -->
        <div class="mb-6">
            <label
                for="project-type"
                class="block font-mono text-xs uppercase tracking-widest text-gray-500 mb-2"
            >
                Tipo de proyecto
            </label>
            <select
                id="project-type"
                name="project-type"
                class="w-full px-4 py-3 border-2 border-black focus:outline-none focus:ring-2 focus:ring-black font-mono text-sm bg-white"
            >
                <option value="">Selecciona una opción</option>
                <option value="software-medida">Software a la medida</option>
                <option value="aplicacion-web">Aplicación web</option>
                <option value="landing-page">Landing page</option>
                <option value="consulta">Consulta general</option>
                <option value="otro">Otro</option>
            </select>
        </div>

        <!-- Mensaje -->
        <div class="mb-6">
            <label
                for="message"
                class="block font-mono text-xs uppercase tracking-widest text-gray-500 mb-2"
            >
                Mensaje *
            </label>
            <textarea
                id="message"
                name="message"
                required
                rows="6"
                class="w-full px-4 py-3 border-2 border-black focus:outline-none focus:ring-2 focus:ring-black font-mono text-sm resize-none"
                placeholder="Cuéntame sobre tu proyecto o consulta..."
            ></textarea>
        </div>

        <!-- Hidden fields para FormSpree -->
        <input type="hidden" name="_subject" value="Nuevo mensaje desde AngoZero Portfolio" />
        <input type="hidden" name="_replyto" value={site.contactEmail} />
        <input type="text" name="_gotcha" style="display:none" />

        <!-- Botón de envío -->
        <div class="flex flex-col sm:flex-row gap-4 items-center">
            <button
                type="submit"
                class="w-full sm:w-auto px-8 py-4 border-2 border-black bg-black text-white font-mono uppercase tracking-widest text-sm hover:bg-white hover:text-black transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
                Enviar mensaje
            </button>

            <p class="text-xs font-mono text-gray-500">
                o escríbeme a
                <a
                    href={`mailto:${site.contactEmail}`}
                    class="text-black font-bold hover:underline"
                >
                    {site.contactEmail}
                </a>
            </p>
        </div>

        <!-- Mensaje de estado -->
        <div
            id="form-status"
            class="mt-6 p-4 border-2 border-black hidden"
            role="alert"
        >
        </div>
    </form>
</div>

<script>
    const form = document.getElementById('contact-form') as HTMLFormElement;
    const statusDiv = document.getElementById('form-status');

    if (form && statusDiv) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
            const originalText = submitBtn.textContent;

            // Deshabilitar botón y cambiar texto
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';

            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    // Éxito
                    statusDiv.className = 'mt-6 p-4 border-2 border-black bg-white';
                    statusDiv.innerHTML = `
                        <p class="font-mono text-sm text-black">
                            ✓ Mensaje enviado con éxito. Te responderé en 24-48 horas.
                        </p>
                    `;
                    form.reset();
                } else {
                    throw new Error('Error al enviar');
                }
            } catch (error) {
                // Error
                statusDiv.className = 'mt-6 p-4 border-2 border-black bg-gray-100';
                statusDiv.innerHTML = `
                    <p class="font-mono text-sm text-black">
                        ✗ Hubo un error. Por favor, envíame un email directamente a
                        <a href="mailto:${form.dataset.email}" class="underline font-bold">
                            ${form.dataset.email}
                        </a>
                    </p>
                `;
            } finally {
                // Restaurar botón
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                statusDiv.classList.remove('hidden');

                // Scroll al mensaje de estado
                statusDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        });
    }
</script>

<style>
    input:focus, textarea:focus, select:focus {
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
    }
</style>
